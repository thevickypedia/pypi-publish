# This workflow will upload a Python Package using Twine when a release is created

name: pypi-publisher
description: GitHub action to upload Python distribution packages to PyPI
inputs:
  user:
    description: PyPI user
    required: false
    default: __token__
  token:
    description: Password for your PyPI user or an access token
    required: true
  dry-run:
    description: Upload distributions to TestPyPI
    required: false
    default: 'false'
  repository-url:
    description: The repository URL to use
    required: false
  packages-dir:
    description: The target directory for distribution
    required: false
    default: dist
  verify-metadata:
    description: Check metadata before uploading
    required: false
    default: 'true'
  skip-existing:
    description: >-
      Do not fail if a Python package distribution
      exists in the target package index
    required: false
    default: 'false'
  verbose:
    description: Show verbose output.
    required: false
    default: 'false'
  print-hash:
    description: Show hash values of files to be uploaded
    required: false
    default: 'false'
branding:
  color: gray-dark
  icon: package

outputs: { }

# Controls when the workflow will run
runs:
  using: composite
  steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Arguments
      run: |
        TWINE_EXTRA_ARGS=--disable-progress-bar
        if [[ ${{ inputs.skip-existing }} != "false" ]] ; then
          TWINE_EXTRA_ARGS="${TWINE_EXTRA_ARGS} --skip-existing"
        fi
        if [[ ${{ inputs.verbose }} != "false" ]] ; then
          TWINE_EXTRA_ARGS="--verbose $TWINE_EXTRA_ARGS"
        fi
        echo "TWINE_EXTRA_ARGS=$TWINE_EXTRA_ARGS" >> $GITHUB_ENV

        if [[ ${{ inputs.dry-run }} != "false" ]] ; then
          echo "repository_url=https://test.pypi.org/simple/" >> $GITHUB_ENV
        else
          echo "repository_url=https://upload.pypi.org/legacy/" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
      shell: bash

    - name: Create packages
      run: python -m build
      shell: bash

    - name: Run twine check
      if: inputs.verify-metadata != false
      run: twine check ${{ inputs.packages-dir }}/*
      shell: bash

    - name: Print hash
      if: inputs.print-hash != false || inputs.verbose != false
      run: |
        import hashlib
        import pathlib
        import sys

        distro = "${{ inputs.packages-dir }}"
        packages_dir = pathlib.Path(distro).resolve().absolute()

        print('Showing hash values of files to be uploaded:')

        for file_object in packages_dir.iterdir():
            sha256 = hashlib.sha256()
            md5 = hashlib.md5()  # noqa: S324; only use for reference
            blake2_256 = hashlib.blake2b(digest_size=256 // 8)

            print(file_object)
            print('')

            content = file_object.read_bytes()

            sha256.update(content)
            md5.update(content)
            blake2_256.update(content)

            print(f'SHA256: {sha256.hexdigest()}')
            print(f'MD5: {md5.hexdigest()}')
            print(f'BLAKE2-256: {blake2_256.hexdigest()}')
            print('')
      shell: python

    - name: Upload to pypi
      env:
        TWINE_USERNAME: ${{ inputs.user }}
        TWINE_PASSWORD: ${{ inputs.token }}
        TWINE_REPOSITORY_URL: ${{ env.repository_url }}
      run: twine upload ${{ env.TWINE_EXTRA_ARGS }} ${{ inputs.packages-dir }}/*.whl
      shell: bash
